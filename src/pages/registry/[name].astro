---
import DefaultLayout from "@/layouts/default-layout.astro";
import registryData from "@/lib/registry/registry.json";
import { readFileSync } from "node:fs";
import { join, basename } from "node:path";
import { fileURLToPath } from "node:url";
import { Code } from "astro-expressive-code/components";
import { CommandTabs } from "@/components/registry/command-tabs";

const __dirname = fileURLToPath(new URL(".", import.meta.url));
const projectRoot = join(__dirname, "../../../");

const { name } = Astro.params;

if (!name) {
  return Astro.redirect("/registry");
}

const item = registryData.items.find((item) => item.name === name);
const registryUrl = `${Astro.url.origin}/registry/${name}.json`;

if (!item) {
  return Astro.redirect("/registry");
}

// Read file contents
// The registry path uses "registry/default" for shadcn CLI installation,
// but the actual source code is in src/lib/registry/ with the rest of the path
const files = item.files.map((file) => {
  const sourcePath = file.path.replace(/^registry\/default/, "lib/registry");
  const filePath = join(projectRoot, "src", sourcePath);
  const content = readFileSync(filePath, "utf-8");
  // Extract language from file extension
  const extension = file.path.split(".").pop() || "";
  const langMap: Record<string, string> = {
    ts: "typescript",
    tsx: "tsx",
    js: "javascript",
    jsx: "jsx",
    css: "css",
    scss: "scss",
    json: "json",
    md: "markdown",
    mdx: "mdx",
    html: "html",
    astro: "astro",
  };
  const lang = langMap[extension] || extension;
  const fileName = basename(file.path);
  return {
    ...file,
    content,
    lang,
    fileName,
  };
});
---

<DefaultLayout headProps={{ title: `${item.title} - Registry` }}>
  <div class="max-w-4xl mx-auto">
    <div class="mb-8">
      <a
        href="/registry"
        class="text-muted-foreground hover:text-foreground mb-4 inline-block"
      >
        ‚Üê Back to Registry
      </a>
      <h1 class="text-3xl font-bold mb-2">{item.title}</h1>
      <p class="text-muted-foreground mb-4">{item.description}</p>
      <div class="flex items-center gap-4 text-sm">
        <a
          href={`/registry/${name}.json`}
          class="text-primary hover:underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          View JSON
        </a>
        {
          item.dependencies && item.dependencies.length > 0 && (
            <span class="text-muted-foreground">
              Dependencies: {item.dependencies.join(", ")}
            </span>
          )
        }
      </div>
    </div>

    <article class="prose">
      <div class="space-y-6">
        {
          files.map((file) => (
            <div>
              <Code
                code={file.content}
                lang={file.lang}
                title={file.fileName}
              />
            </div>
          ))
        }
      </div>
    </article>

    <div class="mt-8">
      <h3 class="font-semibold mb-2">Install with the shadcn CLI</h3>
      <CommandTabs registryUrl={registryUrl} client:load />
    </div>
  </div>
</DefaultLayout>
